name: github-actions-java


on:
  workflow_dispatch:
    inputs:
      myenv:
        description: 'the env to run on'
        default: 'dev'
        #: 'test'
        required: true
  push:
    branches:
    - main
    - release
    

jobs:
  matrix_prep:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
    - id: set-matrix
      run: |
        branchName=$(echo '${{ github.ref }}' | sed 's,refs/heads/,,g') 
        branchName=$(echo '${{ github.ref }}' | sed 's,refs/heads/,,g')  
        matrix=$branchName                
        echo ::set-output name=matrix::{\"include\":$(echo $matrix)}\"
  some_job:
    if: github.ref == 'refs/heads/release' 
    strategy:
      matrix:
        environment: ['non-prod','test']
        #githubbranch: [1]
        github.ref: ['refs/heads/release','refs/heads/main']
        exclude:
        - environment: 'non-prod'
          github.ref: 'refs/heads/release'
        - environment: 'test'
          github.ref: 'refs/heads/main'
          
          
    environment:
      name: ${{ matrix.environment }}
    runs-on: ubuntu-20.04
    name: some job
    steps:
      - name: say hi
        run: echo hi
      - run: |
            branchName=$(echo '${{ github.ref }}' | sed 's,refs/heads/,,g') 
            echo $branchName
      - name: show env
        env:  
          name: ${{ secrets.AWS_KEY }}"
        run: echo "Name_key:$name"
      - run: echo "${{ matrix.github.ref }} "
      #== 'refs/heads/release' }}
  Build-UAT:
    if: github.event_name != 'pull_request' && ( needs.UnitTest-UAT.result == 'success' || github.ref == 'refs/heads/release' ) || ( needs.UnitTest.result == 'success' || github.ref == 'refs/heads/main' )
    needs: some_job
    name: Build-UAT
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - run: pwd
      - run: tree

  Fortify-SAST:
  
    needs: Build-UAT
    runs-on: ubuntu-latest
     
    outputs:
        output1: ${{ env.JOB_TOKEN }} # try outputting job token to use in additional jobs
     
    steps:
    - uses: actions/checkout@v1
    - name: Run PowerShell Get Critical/High Count script
      run: |
        ls
          
    
  # job to get count of Critical/High vulnerabilities associated with this repo
  Fortifyanalysis:
    if: needs.Fortify-SAST.result == 'success'
    needs: Fortify-SAST # this setting makes this job dependent on build completing successfully
 
    runs-on: ubuntu-latest
     
    steps:
    - uses: actions/checkout@v1
    - name: Run PowerShell Get Critical/High Count script
      run: |
        ls
 
      

  DeployArtifacts-Test:
    if: needs.Fortifyanalysis.result == 'success' 
    needs: Fortifyanalysis
    runs-on: ubuntu-latest
   # environment: TEST
    steps:
    - uses: actions/checkout@v2
    - run: echo "this job is not completed yet" 
 
  IntegrationTest:
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main'
    needs: DeployArtifacts-Test 
    name: IntegrationTest
    runs-on: ubuntu-latest
   
    
    steps:
    - uses: actions/checkout@v2
    - run: echo "this job is not completed yet" 
 
   
    
  LoadTest:
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main'  && success()
    needs: IntegrationTest
    name: Run Load Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Load test status - Jmeter
      run: echo "This Job would get updated soon"
